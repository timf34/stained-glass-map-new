---
/**
 * Homepage - Stained Glass Map
 *
 * Main page with:
 * - Celtic header
 * - Sidebar (desktop) / Bottom drawer (mobile)
 * - Interactive map
 */

import BaseLayout from '../layouts/BaseLayout.astro';
import CelticHeader from '../components/CelticHeader.astro';
import Sidebar from '../components/Sidebar';
import MobileDrawer from '../components/MobileDrawer';
import MapWithModal from '../components/MapWithModal';
import { getCollection } from 'astro:content';

// Load all content
const locations = await getCollection('locations');
const artists = await getCollection('artists');

// Prepare data for Map component
const mapLocations = locations.map((loc) => {
  // Extract unique artist slugs from windows
  const artistSlugs = [...new Set(
    loc.data.windows
      .map(w => w.artist)
      .filter(Boolean) as string[]
  )];

  // Swap coordinates from [lat, lng] to [lng, lat] for Mapbox
  const [lat, lng] = loc.data.coordinates;

  return {
    id: loc.id,
    name: loc.data.name,
    coordinates: [lng, lat] as [number, number],
    county: loc.data.county,
    artists: artistSlugs,
  };
});

// Prepare data for FilterControls
const artistOptions = artists
  .map((a) => ({
    slug: a.data.slug,
    name: a.data.name,
  }))
  .sort((a, b) => a.name.localeCompare(b.name));

const countyOptions = [...new Set(locations.map((loc) => loc.data.county))]
  .sort();

// Prepare location data for sidebar (with thumbnails)
const sidebarLocations = locations.map((loc) => {
  const artistSlugs = [...new Set(
    loc.data.windows
      .map(w => w.artist)
      .filter(Boolean) as string[]
  )];
  const firstWindow = loc.data.windows[0];
  const thumbnailUrl = firstWindow?.images[0]?.url || '/placeholder.jpg';

  return {
    id: loc.id,
    name: loc.data.name,
    county: loc.data.county,
    artists: artistSlugs,
    thumbnailUrl,
  };
});

// Prepare full location data for modal
const fullLocations = locations.map((loc) => ({
  id: loc.id,
  name: loc.data.name,
  address: loc.data.address,
  county: loc.data.county,
  description: loc.data.description,
  google_maps_link: loc.data.google_maps_link,
  windows: loc.data.windows,
}));

// Create artist name mapping (slug â†’ name) for modal display
const artistNames = Object.fromEntries(
  artists.map((a) => [a.data.slug, a.data.name])
);

// Get Mapbox token from environment
const mapboxToken = import.meta.env.PUBLIC_MAPBOX_TOKEN;
---

<BaseLayout title="Home">
  <CelticHeader />

  <main class="container">
    <!-- Desktop Layout -->
    <div class="desktop-layout">
      <div class="sidebar">
        <Sidebar
          locations={sidebarLocations}
          artists={artistOptions}
          counties={countyOptions}
          client:load
        />
      </div>
      <div class="map-container">
        <MapWithModal
          locations={mapLocations}
          fullLocations={fullLocations}
          artistNames={artistNames}
          mapboxToken={mapboxToken}
          client:load
        />
      </div>
    </div>

    <!-- Mobile Layout -->
    <div class="mobile-layout">
      <div class="mobile-map-container">
        <MapWithModal
          locations={mapLocations}
          fullLocations={fullLocations}
          artistNames={artistNames}
          mapboxToken={mapboxToken}
          client:load
        />
      </div>
      <MobileDrawer
        locations={sidebarLocations}
        artists={artistOptions}
        counties={countyOptions}
        client:load
      />
    </div>
  </main>
</BaseLayout>

<style>
  /* Desktop Layout */
  .desktop-layout {
    display: grid;
    grid-template-columns: minmax(320px, 400px) 1fr;
    gap: var(--spacing-md);
    height: calc(100vh - 80px);
    padding: var(--spacing-md);
  }

  .sidebar {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
  }

  .map-container {
    background: var(--color-card-bg);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    overflow: hidden;
    height: 100%;
  }

  /* Mobile Layout - Hidden on desktop */
  .mobile-layout {
    display: none;
  }

  /* Mobile styles */
  @media (max-width: 768px) {
    /* Hide desktop layout on mobile */
    .desktop-layout {
      display: none;
    }

    /* Show mobile layout */
    .mobile-layout {
      display: block;
      height: calc(100vh - 60px); /* Smaller header on mobile */
      position: relative;
    }

    .mobile-map-container {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 60px; /* Space for drawer peek */
      background: var(--color-card-bg);
    }

    /* Remove container padding on mobile */
    .container {
      padding: 0;
      max-width: none;
    }
  }
</style>
